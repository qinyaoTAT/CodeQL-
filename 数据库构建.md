## 数据库构建

[TOC]

文档以Python举例，其他语言的思路应该是一致的，可能方法上略有不同：

主要流程大概是：数据库初始化 --> 提取器执行（通过AST生成trap文件） -- trap文件导入原始数据集 -- 生成最终database数据库

### 一、创建数据库

创建命令：

```
codeql database create codeql_security_test2 --language=python --source-root=D:\qy\codeql\codeql_learn
```

### 二、数据库目录结构

- db-python：
- log：创建和查询日志
- results：查询结果的bqrs文件，用来转换为其他结果格式
- src.zip：源代码

### 三、数据库生成原理

1、分析数据库构建日志

实际创建一个数据库，查看日志，大致分为一下三个阶段：

- 数据库初始化：

  创建空的codeql数据库

  ![image-20230116173531095](C:\Users\qinyao\AppData\Roaming\Typora\typora-user-images\image-20230116173531095.png)

- 提取器执行：

  ![image-20230116173652258](C:\Users\qinyao\AppData\Roaming\Typora\typora-user-images\image-20230116173652258.png)

  从上图可以看到提取器执行trace-command命令，以及自动构建脚本autobuild.cmd，接下来详细分析：

  - 进入codeql命令行工具Python目录，从自动构建脚本开始跟踪

- 数据集导入：

2、自动构建脚本

3、Python tracer

4、提取器

5、trap文件

6、rel文件

